{% extends 'authentication/base_logged_in.html' %}
{% load custom_filters %}
{% block title %}Edit Quiz - {{ quiz.title }} | SriPedia{% endblock %}

{% block extra_head %}
<style>
    .question-card {
        margin-bottom: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background-color: #f9f9f9;
    }
    
    .option-row {
        margin-bottom: 10px;
        padding: 8px;
        border-radius: 5px;
    }
    
    .option-row:hover {
        background-color: #f0f0f0;
    }
    
    .correct-option {
        background-color: #d4edda;
        border-color: #c3e6cb;
    }
    
    .controls {
        margin-top: 20px;
    }
    
    .add-question-btn {
        margin-bottom: 20px;
    }
    
    .error-message {
        color: #dc3545;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'classroom_list' %}">Classrooms</a></li>
            <li class="breadcrumb-item"><a href="{% url 'classroom_detail' classroom.id %}">{{ classroom.name }}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'classroom_quizzes' classroom.id %}">Quizzes</a></li>
            <li class="breadcrumb-item"><a href="{% url 'quiz_detail' classroom.id quiz.id %}">{{ quiz.title }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">Edit</li>
        </ol>
    </nav>

    <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h2 class="mb-0">Edit Quiz</h2>
            <a href="{% url 'quiz_detail' classroom.id quiz.id %}" class="btn btn-outline-light">Cancel</a>
        </div>
        <div class="card-body">
            {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
            {% endif %}

            <!-- Quiz Details Form -->
            <div id="quiz-details-form">
                <div class="mb-3">
                    <label for="quiz-title" class="form-label">Quiz Title</label>
                    <input type="text" class="form-control" id="quiz-title" value="{{ quiz.title }}" required>
                </div>

                <div class="mb-3">
                    <label for="quiz-description" class="form-label">Description</label>
                    <textarea class="form-control" id="quiz-description" rows="3">{{ quiz.description }}</textarea>
                </div>

                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="is-published" {% if quiz.is_published %}checked{% endif %}>
                    <label class="form-check-label" for="is-published">Publish Quiz (make visible to students)</label>
                </div>
            </div>

            <!-- Questions Section -->
            <h4 class="mt-4 mb-3">Questions</h4>
            <div class="error-message d-none" id="questions-error"></div>
            
            <div id="questions-container">
                {% for question in questions %}
                <div class="question-card" data-question-index="{{ forloop.counter0 }}">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h5>Question {{ forloop.counter }}</h5>
                        <button type="button" class="btn btn-sm btn-danger remove-question-btn">Remove</button>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Question Text</label>
                        <textarea class="form-control question-text" rows="2" required>{{ question.question_text }}</textarea>
                    </div>
                    
                    <div class="options-container">
                        {% for option in question.options.all %}
                        <div class="option-row {% if option.is_correct %}correct-option{% endif %}" data-option-index="{{ forloop.counter0 }}">
                            <div class="d-flex align-items-center">
                                <div class="form-check me-2">
                                    <input class="form-check-input correct-option-radio" type="radio" 
                                        name="correct-option-{{ forloop.parentloop.counter0 }}" 
                                        {% if option.is_correct %}checked{% endif %}>
                                </div>
                                <div class="flex-grow-1">
                                    <input type="text" class="form-control option-text" 
                                        value="{{ option.option_text }}" 
                                        placeholder="Option {{ forloop.counter }}" required>
                                </div>
                                {% if forloop.counter > 2 %}
                                <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-option-btn">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <!-- Default 4 options if none exist -->
                        {% for i in '1234' %}
                        <div class="option-row {% if forloop.counter0 == 0 %}correct-option{% endif %}" data-option-index="{{ forloop.counter0 }}">
                            <div class="d-flex align-items-center">
                                <div class="form-check me-2">
                                    <input class="form-check-input correct-option-radio" type="radio" 
                                        name="correct-option-{{ forloop.parentloop.counter0 }}" 
                                        {% if forloop.counter0 == 0 %}checked{% endif %}>
                                </div>
                                <div class="flex-grow-1">
                                    <input type="text" class="form-control option-text" 
                                        placeholder="Option {{ forloop.counter }}" required>
                                </div>
                                {% if forloop.counter > 2 %}
                                <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-option-btn">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        {% endfor %}
                    </div>
                    
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2 add-option-btn">
                        Add Option
                    </button>
                </div>
                {% empty %}
                <!-- Default first question if none exist -->
                <div class="question-card" data-question-index="0">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h5>Question 1</h5>
                        <button type="button" class="btn btn-sm btn-danger remove-question-btn">Remove</button>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Question Text</label>
                        <textarea class="form-control question-text" rows="2" required></textarea>
                    </div>
                    
                    <div class="options-container">
                        {% for i in '1234' %}
                        <div class="option-row {% if forloop.counter0 == 0 %}correct-option{% endif %}" data-option-index="{{ forloop.counter0 }}">
                            <div class="d-flex align-items-center">
                                <div class="form-check me-2">
                                    <input class="form-check-input correct-option-radio" type="radio" 
                                        name="correct-option-0" 
                                        {% if forloop.counter0 == 0 %}checked{% endif %}>
                                </div>
                                <div class="flex-grow-1">
                                    <input type="text" class="form-control option-text" 
                                        placeholder="Option {{ forloop.counter }}" required>
                                </div>
                                {% if forloop.counter > 2 %}
                                <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-option-btn">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2 add-option-btn">
                        Add Option
                    </button>
                </div>
                {% endfor %}
            </div>

            <button type="button" id="add-question-btn" class="btn btn-success add-question-btn mt-3">
                <i class="bi bi-plus-circle me-1"></i> Add Question
            </button>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <button type="button" id="save-quiz-btn" class="btn btn-primary">Save Quiz</button>
                <a href="{% url 'quiz_detail' classroom.id quiz.id %}" class="btn btn-outline-secondary">Cancel</a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Constants
    const QUESTION_TEMPLATE = `
        <div class="question-card" data-question-index="{INDEX}">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <h5>Question {NUMBER}</h5>
                <button type="button" class="btn btn-sm btn-danger remove-question-btn">Remove</button>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Question Text</label>
                <textarea class="form-control question-text" rows="2" required></textarea>
            </div>
            
            <div class="options-container">
                <div class="option-row correct-option" data-option-index="0">
                    <div class="d-flex align-items-center">
                        <div class="form-check me-2">
                            <input class="form-check-input correct-option-radio" type="radio" name="correct-option-{INDEX}" checked>
                        </div>
                        <div class="flex-grow-1">
                            <input type="text" class="form-control option-text" placeholder="Option 1" required>
                        </div>
                    </div>
                </div>
                <div class="option-row" data-option-index="1">
                    <div class="d-flex align-items-center">
                        <div class="form-check me-2">
                            <input class="form-check-input correct-option-radio" type="radio" name="correct-option-{INDEX}">
                        </div>
                        <div class="flex-grow-1">
                            <input type="text" class="form-control option-text" placeholder="Option 2" required>
                        </div>
                    </div>
                </div>
            </div>
            
            <button type="button" class="btn btn-sm btn-outline-primary mt-2 add-option-btn">
                Add Option
            </button>
        </div>
    `;

    const OPTION_TEMPLATE = `
        <div class="option-row" data-option-index="{INDEX}">
            <div class="d-flex align-items-center">
                <div class="form-check me-2">
                    <input class="form-check-input correct-option-radio" type="radio" name="correct-option-{QUESTION_INDEX}">
                </div>
                <div class="flex-grow-1">
                    <input type="text" class="form-control option-text" placeholder="Option {NUMBER}" required>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-option-btn">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;

    // Add a new question
    document.getElementById('add-question-btn').addEventListener('click', function() {
        const questionsContainer = document.getElementById('questions-container');
        const questionCount = questionsContainer.querySelectorAll('.question-card').length;
        const newIndex = questionCount;
        const newNumber = questionCount + 1;
        
        // Create new question element using template
        const newQuestionHTML = QUESTION_TEMPLATE
            .replace(/{INDEX}/g, newIndex)
            .replace(/{NUMBER}/g, newNumber);
        
        questionsContainer.insertAdjacentHTML('beforeend', newQuestionHTML);
        attachEventListeners();
    });

    // Save quiz function
    document.getElementById('save-quiz-btn').addEventListener('click', function() {
        const quizData = collectQuizData();
        
        if (!validateQuizData(quizData)) {
            return;
        }
        
        // Send AJAX request
        fetch('', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(quizData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = data.redirect_url;
            } else {
                showError('An error occurred: ' + data.error);
            }
        })
        .catch(error => {
            showError('An error occurred while saving the quiz.');
            console.error('Error:', error);
        });
    });

    // Attach event listeners to dynamic elements
    function attachEventListeners() {
        // Remove question buttons
        document.querySelectorAll('.remove-question-btn').forEach(button => {
            button.removeEventListener('click', removeQuestionHandler);
            button.addEventListener('click', removeQuestionHandler);
        });
        
        // Add option buttons
        document.querySelectorAll('.add-option-btn').forEach(button => {
            button.removeEventListener('click', addOptionHandler);
            button.addEventListener('click', addOptionHandler);
        });
        
        // Remove option buttons
        document.querySelectorAll('.remove-option-btn').forEach(button => {
            button.removeEventListener('click', removeOptionHandler);
            button.addEventListener('click', removeOptionHandler);
        });
        
        // Correct option radio buttons
        document.querySelectorAll('.correct-option-radio').forEach(radio => {
            radio.removeEventListener('change', correctOptionHandler);
            radio.addEventListener('change', correctOptionHandler);
        });
    }

    // Handler for removing questions
    function removeQuestionHandler(event) {
        const questionCard = event.target.closest('.question-card');
        const questionsContainer = document.getElementById('questions-container');
        
        // Don't remove if it's the last question
        if (questionsContainer.querySelectorAll('.question-card').length <= 1) {
            showError('You must have at least one question.');
            return;
        }
        
        questionCard.remove();
        
        // Renumber remaining questions
        questionsContainer.querySelectorAll('.question-card').forEach((card, index) => {
            card.querySelector('h5').textContent = `Question ${index + 1}`;
            card.dataset.questionIndex = index;
            card.querySelectorAll('.correct-option-radio').forEach(radio => {
                radio.name = `correct-option-${index}`;
            });
        });
    }

    // Handler for adding options
    function addOptionHandler(event) {
        const questionCard = event.target.closest('.question-card');
        const optionsContainer = questionCard.querySelector('.options-container');
        const optionCount = optionsContainer.querySelectorAll('.option-row').length;
        
        // Maximum of 6 options
        if (optionCount >= 6) {
            showError('Maximum 6 options allowed per question.');
            return;
        }
        
        const questionIndex = questionCard.dataset.questionIndex;
        const newOptionIndex = optionCount;
        
        // Create new option using template
        const newOptionHTML = OPTION_TEMPLATE
            .replace(/{INDEX}/g, newOptionIndex)
            .replace(/{QUESTION_INDEX}/g, questionIndex)
            .replace(/{NUMBER}/g, optionCount + 1);
        
        optionsContainer.insertAdjacentHTML('beforeend', newOptionHTML);
        attachEventListeners();
    }

    // Handler for removing options
    function removeOptionHandler(event) {
        const optionRow = event.target.closest('.option-row');
        const optionsContainer = optionRow.parentElement;
        
        // Don't remove if there are only 2 options
        if (optionsContainer.querySelectorAll('.option-row').length <= 2) {
            showError('Each question must have at least 2 options.');
            return;
        }
        
        // Check if we're removing the correct option
        if (optionRow.classList.contains('correct-option')) {
            // Select the first option as correct by default
            const firstOption = optionsContainer.querySelector('.option-row');
            firstOption.classList.add('correct-option');
            firstOption.querySelector('.correct-option-radio').checked = true;
        }
        
        optionRow.remove();
        
        // Update option indices
        optionsContainer.querySelectorAll('.option-row').forEach((row, index) => {
            row.dataset.optionIndex = index;
        });
    }

    // Handler for correct option selection
    function correctOptionHandler(event) {
        const optionRow = event.target.closest('.option-row');
        const questionCard = optionRow.closest('.question-card');
        
        // Remove correct-option class from all options in this question
        questionCard.querySelectorAll('.option-row').forEach(row => {
            row.classList.remove('correct-option');
        });
        
        // Add correct-option class to the selected option
        optionRow.classList.add('correct-option');
    }

    // Collect quiz data from the form
    function collectQuizData() {
        const title = document.getElementById('quiz-title').value.trim();
        const description = document.getElementById('quiz-description').value.trim();
        const isPublished = document.getElementById('is-published').checked;
        
        const questions = [];
        document.querySelectorAll('.question-card').forEach(card => {
            const questionText = card.querySelector('.question-text').value.trim();
            const options = [];
            
            card.querySelectorAll('.option-row').forEach(row => {
                const optionText = row.querySelector('.option-text').value.trim();
                const isCorrect = row.classList.contains('correct-option');
                
                options.push({
                    text: optionText,
                    is_correct: isCorrect
                });
            });
            
            questions.push({
                text: questionText,
                options: options
            });
        });
        
        return {
            title,
            description,
            is_published: isPublished,
            questions
        };
    }

    // Validate quiz data
    function validateQuizData(data) {
        // Check title
        if (!data.title) {
            showError('Quiz title is required.');
            return false;
        }
        
        // Check questions
        if (data.questions.length === 0) {
            showError('You must add at least one question.');
            return false;
        }
        
        // Check each question
        for (let i = 0; i < data.questions.length; i++) {
            const question = data.questions[i];
            
            if (!question.text) {
                showError(`Question ${i + 1} text is required.`);
                return false;
            }
            
            if (question.options.length < 2) {
                showError(`Question ${i + 1} must have at least 2 options.`);
                return false;
            }
            
            // Check each option
            let hasCorrectOption = false;
            for (let j = 0; j < question.options.length; j++) {
                const option = question.options[j];
                
                if (!option.text) {
                    showError(`Option ${j + 1} in Question ${i + 1} text is required.`);
                    return false;
                }
                
                if (option.is_correct) {
                    hasCorrectOption = true;
                }
            }
            
            if (!hasCorrectOption) {
                showError(`Question ${i + 1} must have a correct option selected.`);
                return false;
            }
        }
        
        return true;
    }

    // Show error message
    function showError(message) {
        const errorElement = document.getElementById('questions-error');
        errorElement.textContent = message;
        errorElement.classList.remove('d-none');
        
        // Scroll to error message
        errorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Hide after 5 seconds
        setTimeout(() => {
            errorElement.classList.add('d-none');
        }, 5000);
    }

    // Get CSRF token
    function getCsrfToken() {
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
        return cookieValue;
    }

    // Initial setup
    attachEventListeners();
});
</script>
{% endblock %}