{% extends 'authentication/base_logged_in.html' %}
{% load custom_filters %}

{% block title %}Create Quiz - {{ classroom.name }}{% endblock %}

{% block extra_css %}
<style>
    .question-card {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        position: relative;
    }
    .option-row {
        margin-bottom: 10px;
    }
    .remove-question-btn {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    .option-correct-label {
        cursor: pointer;
    }
    .drag-handle {
        cursor: move;
        color: #aaa;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Create Quiz - {{ classroom.name }}</h1>
        <a href="{% url 'classroom_quizzes' classroom.id %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Quizzes
        </a>
    </div>

    {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Quiz Details</h4>
        </div>
        <div class="card-body">
            <form id="quizForm">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="title" class="form-label">Quiz Title</label>
                    <input type="text" class="form-control" id="title" name="title" required>
                </div>
                
                <div class="mb-3">
                    <label for="description" class="form-label">Description (Optional)</label>
                    <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                </div>

                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="is_published" name="is_published">
                    <label class="form-check-label" for="is_published">Publish Quiz (immediately available to students)</label>
                </div>

                <hr class="my-4">
                <h4>Questions</h4>

                <div id="questionsContainer">
                    <!-- Questions will be added here dynamically -->
                </div>

                <button type="button" id="addQuestionBtn" class="btn btn-success mt-3">
                    <i class="fas fa-plus"></i> Add Question
                </button>

                <hr class="my-4">
                <div class="d-flex justify-content-between">
                    <a href="{% url 'classroom_quizzes' classroom.id %}" class="btn btn-outline-secondary">Cancel</a>
                    <button type="submit" id="saveQuizBtn" class="btn btn-primary">Save Quiz</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Question template (hidden) -->
<template id="questionTemplate">
    <div class="question-card" data-question-index="__INDEX__">
        <button type="button" class="btn btn-sm btn-outline-danger remove-question-btn">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="mb-3">
            <label class="form-label">Question <span class="question-number">__NUMBER__</span></label>
            <textarea class="form-control question-text" name="question_text" rows="2" required></textarea>
        </div>
        
        <div class="options-container">
            <div class="option-row" data-option-index="0">
                <div class="input-group">
                    <div class="input-group-text">
                        <input type="radio" name="correct_option_q__INDEX__" value="0" required>
                    </div>
                    <input type="text" class="form-control option-text" placeholder="Option 1" required>
                    <button type="button" class="btn btn-outline-danger remove-option-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="option-row" data-option-index="1">
                <div class="input-group">
                    <div class="input-group-text">
                        <input type="radio" name="correct_option_q__INDEX__" value="1" required>
                    </div>
                    <input type="text" class="form-control option-text" placeholder="Option 2" required>
                    <button type="button" class="btn btn-outline-danger remove-option-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <button type="button" class="btn btn-sm btn-outline-primary add-option-btn mt-2">
            <i class="fas fa-plus"></i> Add Option
        </button>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let questionCount = 0;
        const questionTemplate = document.getElementById('questionTemplate');
        const questionsContainer = document.getElementById('questionsContainer');
        
        // Add initial question
        addQuestion();
        
        // Add question button
        document.getElementById('addQuestionBtn').addEventListener('click', addQuestion);
        
        // Form submission
        document.getElementById('quizForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveQuiz();
        });
        
        // Event delegation for dynamic buttons
        questionsContainer.addEventListener('click', function(e) {
            // Remove question
            if (e.target.closest('.remove-question-btn')) {
                const questionCard = e.target.closest('.question-card');
                if (document.querySelectorAll('.question-card').length > 1) {
                    questionCard.remove();
                    updateQuestionNumbers();
                } else {
                    alert('Quiz must have at least one question.');
                }
            }
            
            // Add option
            if (e.target.closest('.add-option-btn')) {
                const questionCard = e.target.closest('.question-card');
                const optionsContainer = questionCard.querySelector('.options-container');
                const optionIndex = optionsContainer.querySelectorAll('.option-row').length;
                
                if (optionIndex < 4) {  // Limit to 4 options per question
                    const questionIndex = questionCard.dataset.questionIndex;
                    addOption(optionsContainer, questionIndex, optionIndex);
                } else {
                    alert('Maximum 4 options allowed per question.');
                }
            }
            
            // Remove option
            if (e.target.closest('.remove-option-btn')) {
                const optionRow = e.target.closest('.option-row');
                const optionsContainer = optionRow.parentElement;
                
                if (optionsContainer.querySelectorAll('.option-row').length > 2) {
                    optionRow.remove();
                } else {
                    alert('Question must have at least 2 options.');
                }
            }
        });
        
        function addQuestion() {
            const index = questionCount++;
            const number = document.querySelectorAll('.question-card').length + 1;
            
            let newQuestion = questionTemplate.innerHTML
                .replace(/__INDEX__/g, index)
                .replace(/__NUMBER__/g, number);
                
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newQuestion;
            questionsContainer.appendChild(tempDiv.firstElementChild);
        }
        
        function addOption(container, questionIndex, optionIndex) {
            const optionRow = document.createElement('div');
            optionRow.className = 'option-row';
            optionRow.dataset.optionIndex = optionIndex;
            
            optionRow.innerHTML = `
                <div class="input-group">
                    <div class="input-group-text">
                        <input type="radio" name="correct_option_q${questionIndex}" value="${optionIndex}" required>
                    </div>
                    <input type="text" class="form-control option-text" placeholder="Option ${optionIndex + 1}" required>
                    <button type="button" class="btn btn-outline-danger remove-option-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(optionRow);
        }
        
        function updateQuestionNumbers() {
            document.querySelectorAll('.question-card').forEach((card, idx) => {
                card.querySelector('.question-number').textContent = idx + 1;
            });
        }
        
        function saveQuiz() {
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const isPublished = document.getElementById('is_published').checked;
            
            // Validate title
            if (!title.trim()) {
                alert('Quiz title is required');
                return;
            }
            
            // Collect questions data
            const questions = [];
            const questionCards = document.querySelectorAll('.question-card');
            
            if (questionCards.length === 0) {
                alert('Quiz must have at least one question');
                return;
            }
            
            let isValid = true;
            
            questionCards.forEach(card => {
                const questionText = card.querySelector('.question-text').value.trim();
                if (!questionText) {
                    alert('Question text cannot be empty');
                    isValid = false;
                    return;
                }
                
                const options = [];
                const optionInputs = card.querySelectorAll('.option-text');
                const correctOptionRadios = card.querySelectorAll('input[type="radio"]');
                let correctOption = null;
                
                // Find which option is selected as correct
                correctOptionRadios.forEach((radio, idx) => {
                    if (radio.checked) {
                        correctOption = idx;
                    }
                });
                
                if (correctOption === null) {
                    alert('Please select a correct answer for each question');
                    isValid = false;
                    return;
                }
                
                // Get option texts
                optionInputs.forEach((input, idx) => {
                    const optionText = input.value.trim();
                    if (!optionText) {
                        alert('Option text cannot be empty');
                        isValid = false;
                        return;
                    }
                    
                    options.push({
                        text: optionText,
                        is_correct: idx === correctOption
                    });
                });
                
                // Ensure minimum options
                if (options.length < 2) {
                    alert('Each question must have at least 2 options');
                    isValid = false;
                    return;
                }
                
                questions.push({
                    text: questionText,
                    options: options
                });
            });
            
            if (!isValid) return;
            
            // Prepare data for submission
            const quizData = {
                title: title,
                description: description,
                is_published: isPublished,
                questions: questions
            };
            
            // Send data
            const saveBtn = document.getElementById('saveQuizBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
            
            fetch('{% url "create_quiz" classroom.id %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(quizData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = data.redirect_url;
                } else {
                    alert(`Error: ${data.error || 'Failed to save quiz'}`);
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = 'Save Quiz';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the quiz');
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'Save Quiz';
            });
        }
    });
</script>
{% endblock %}